<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Management - Books</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="headerinfo">
                <h1>Books Management</h1>
                <p>Manage your library collection</p>
            </div>
            <div>
                <a href="/dashboard" class="btnback">Back to Dashboard</a>
            </div>
        </div>

        <div class="navigation">
            <a href="/books" class="navbtn active">Books Management</a>
        </div>

        <div id="status" class="status hidden"></div>

        <div class="content">
            <div class="section">
                <h3>Add New Book</h3>
                <form id="bookform">
                    <div class="formgrid">
                        <div class="formgroup">
                            <label for="booktitle">Title:</label>
                            <input type="text" id="booktitle" required placeholder="Enter book title">
                        </div>
                        <div class="formgroup">
                            <label for="bookauthor">Author:</label>
                            <input type="text" id="bookauthor" required placeholder="Enter author name">
                        </div>
                        <div class="formgroup">
                            <label for="bookcategory">Category:</label>
                            <select id="bookcategory" required>
                                <option value="">Select Category</option>
                                <option value="Fiction">Fiction</option>
                                <option value="Non-Fiction">Non-Fiction</option>
                                <option value="Science">Science</option>
                                <option value="History">History</option>
                                <option value="Romance">Romance</option>
                                <option value="Mystery">Mystery</option>
                                <option value="Fantasy">Fantasy</option>      
                            </select>
                        </div>
                        <div class="formgroup">
                            <label for="bookpublisher">Publisher:</label>
                            <input type="text" id="bookpublisher" placeholder="Publisher name">
                        </div>
                        <div class="formgroup">
                            <label for="bookyear">Publication Year:</label>
                            <input type="number" id="bookyear" min="1800" max="2024" placeholder="2023">
                        </div>
                        <div class="formgroup">
                            <label for="bookcopies">Number of Copies:</label>
                            <input type="number" id="bookcopies" required min="1" placeholder="1">
                        </div>
                    </div>
                    <div class="formgroup">
                        <label for="bookdescription">Description:</label>
                        <textarea id="bookdescription" rows="3" placeholder="Brief description of the book"></textarea>
                    </div>
                    <button type="submit" class="btn">Add Book</button>
                    <button type="button" class="btn btnwarning hidden" id="updatebookbtn" onclick="UpdateBook()">Update Book</button>
                    <button type="button" class="btn" onclick="ClearBookForm()">Clear Form</button>
                </form>
            </div>

            <div class="searchsection">
                <h3>Search Books</h3>
                <div class="searchgrid">
                    <input type="text" id="booksearch" placeholder="Search by title or author...">
                    <select id="categoryfilter">
                        <option value="">All Categories</option>
                        <option value="Fiction">Fiction</option>
                        <option value="Non-Fiction">Non-Fiction</option>
                        <option value="Science">Science</option>
                        <option value="History">History</option>
                        <option value="Biography">Biography</option>
                        <option value="Romance">Romance</option>
                        <option value="Mystery">Mystery</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Philosophy">Philosophy</option>
                        <option value="Technology">Technology</option>
                    </select>
                    <button class="btn btnsuccess" onclick="SearchBooks()">Search</button>
                    <button class="btn" onclick="LoadBooks()">Show All</button>
                </div>
            </div>

            <div class="section">
                <h3>Books Collection</h3>
                <div class="tablecontainer">
                    <div id="bookslist" class="loading">Loading books...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let SelectedBook = null;

        function CheckAuth() {
            const Token = localStorage.getItem('authtoken');
            const UserData = localStorage.getItem('userdata');
            
            if (!Token || !UserData) {
                window.location.href = '/login';
                return false;
            }
            
            return JSON.parse(UserData);
        }

        function ShowStatus(Message, IsError = false) {
            const StatusDiv = document.getElementById('status');
            StatusDiv.textContent = Message;
            StatusDiv.className = `status ${IsError ? 'error' : 'success'}`;
            StatusDiv.classList.remove('hidden');
            setTimeout(() => StatusDiv.classList.add('hidden'), 5000);
        }

        async function LoadBooks() {
            try {
                const Response = await fetch('/api/books');
                const Books = await Response.json();
                DisplayBooks(Books);
            } catch (error) {
                document.getElementById('bookslist').innerHTML = '<p>Error loading books</p>';
            }
        }

        function DisplayBooks(Books) {
            const Container = document.getElementById('bookslist');

            if (!Books || Books.length === 0) {
                Container.innerHTML = '<div class="emptystate"><p>No books found</p></div>';
                return;
            }

            let Html = `
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Category</th>
                            <th>Year</th>
                            <th>Copies</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Books.forEach(book => {
                Html += `
                    <tr>
                        <td><strong>${book.title}</strong></td>
                        <td>${book.author}</td>
                        <td>${book.category}</td>
                        <td>${book.year || 'N/A'}</td>
                        <td>${book.copies}</td>
                        <td>
                            <button class="btn" onclick="ViewBook('${book._id}')">View</button>
                            <button class="btn btnwarning" onclick="EditBook('${book._id}')">Edit</button>
                            <button class="btn btndanger" onclick="DeleteBook('${book._id}')">Delete</button>
                        </td>
                    </tr>
                `;
            });

            Html += '</tbody></table>';
            Container.innerHTML = Html;
        }

        async function SearchBooks() {
            const SearchTerm = document.getElementById('booksearch').value.trim();
            if (!SearchTerm) {
                ShowStatus('Please enter a search term', true);
                return;
            }

            try {
                const Response = await fetch(`/api/books/search?title=${encodeURIComponent(SearchTerm)}`);
                const Books = await Response.json();
                DisplayBooks(Books);
                ShowStatus(`Found ${Books.length} book(s) matching "${SearchTerm}"`);
            } catch (error) {
                ShowStatus('Search failed', true);
            }
        }

        async function ViewBook(BookId) {
            try {
                const Response = await fetch(`/api/books/${BookId}`);
                const Book = await Response.json();

                const Details = `
                    Title: ${Book.title}
                    Author: ${Book.author}
                    Category: ${Book.category}
                    Year: ${Book.year }
                    Publisher: ${Book.publisher}
                    Copies: ${Book.copies}
                    Description: ${Book.description}
                `;

                alert(Details);
            } catch (error) {
                ShowStatus('Failed to load book details', true);
            }
        }

        async function EditBook(BookId) {
            try {
                const Response = await fetch(`/api/books/${BookId}`);
                const Book = await Response.json();

                document.getElementById('booktitle').value = Book.title;
                document.getElementById('bookauthor').value = Book.author;
                document.getElementById('bookcategory').value = Book.category;
                document.getElementById('bookpublisher').value = Book.publisher || '';
                document.getElementById('bookyear').value = Book.year || '';
                document.getElementById('bookcopies').value = Book.copies;
                document.getElementById('bookdescription').value = Book.description || '';

                document.getElementById('updatebookbtn').classList.remove('hidden');
                SelectedBook = Book;

                ShowStatus(`Loaded "${Book.title}" for editing`);
            } catch (error) {
                ShowStatus('Failed to load book for editing', true);
            }
        }

        async function UpdateBook() {
            if (!SelectedBook) return;

            const BookData = {
                title: document.getElementById('booktitle').value.trim(),
                author: document.getElementById('bookauthor').value.trim(),
                category: document.getElementById('bookcategory').value,
                publisher: document.getElementById('bookpublisher').value.trim(),
                year: parseInt(document.getElementById('bookyear').value) || null,
                copies: parseInt(document.getElementById('bookcopies').value),
                description: document.getElementById('bookdescription').value.trim()
            };

            if (!ValidateForm(BookData.title, BookData.author, BookData.category, BookData.copies)) return;

            try {
                const Response = await fetch(`/api/books/${SelectedBook._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(BookData)
                });

                if (Response.ok) {
                    ShowStatus('Book updated successfully!');
                    ClearBookForm();
                    LoadBooks();
                } else {
                    ShowStatus('Failed to update book', true);
                }
            } catch (error) {
                ShowStatus('Failed to update book', true);
            }
        }

        async function DeleteBook(BookId) {
            if (!confirm('Are you sure you want to delete this book?')) return;

            try {
                const Response = await fetch(`/api/books/${BookId}`, { method: 'DELETE' });

                if (Response.ok) {
                    ShowStatus('Book deleted successfully!');
                    LoadBooks();
                } else {
                    ShowStatus('Failed to delete book', true);
                }
            } catch (error) {
                ShowStatus('Failed to delete book', true);
            }
        }

        function ClearBookForm() {
            document.getElementById('bookform').reset();
            document.getElementById('updatebookbtn').classList.add('hidden');
            SelectedBook = null;
        }

        function ValidateForm(Title, Author, Category, Copies) {
            if (!Title) {
                ShowStatus('Please enter book title', true);
                return false;
            }

            if (!Author) {
                ShowStatus('Please enter author name', true);
                return false;
            }

            if (!Category) {
                ShowStatus('Please select a category', true);
                return false;
            }

            if (isNaN(Copies) || Copies < 1) {
                ShowStatus('Please enter a valid number of copies', true);
                return false;
            }

            return true;
        }

        document.getElementById('bookform').addEventListener('submit', async (e) => {
            e.preventDefault();

            const BookData = {
                title: document.getElementById('booktitle').value.trim(),
                author: document.getElementById('bookauthor').value.trim(),
                category: document.getElementById('bookcategory').value,
                publisher: document.getElementById('bookpublisher').value.trim(),
                year: parseInt(document.getElementById('bookyear').value) || null,
                copies: parseInt(document.getElementById('bookcopies').value),
                description: document.getElementById('bookdescription').value.trim()
            };

            if (!ValidateForm(BookData.title, BookData.author, BookData.category, BookData.copies)) return;

            try {
                const Response = await fetch('/api/books', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(BookData)
                });

                if (Response.ok) {
                    ShowStatus('Book added successfully!');
                    ClearBookForm();
                    LoadBooks();
                } else {
                    ShowStatus('Failed to add book', true);
                }
            } catch (error) {
                ShowStatus('Failed to add book', true);
            }
        });

        document.getElementById('booksearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                SearchBooks();
            }
        });

        document.getElementById('categoryfilter').addEventListener('change', async () => {
            const Category = document.getElementById('categoryfilter').value;
            
            try {
                const Response = await fetch(`/api/books/filter?category=${encodeURIComponent(Category)}`);
                const Books = await Response.json();
                DisplayBooks(Books);
                
                if (Category) {
                    ShowStatus(`Showing ${Books.length} books in ${Category} category`);
                }
            } catch (error) {
                ShowStatus('Filter failed', true);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            CheckAuth();
            LoadBooks();
        });
    </script>
</body>
</html>